<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VR Experience</title>
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #loadingScreen {
      position: absolute;
      top:0; left:0; right:0; bottom:0;
      background: black;
      color: white;
      display:flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      font-family: Arial, sans-serif;
      z-index: 1000;
    }
    #enterBtn {
      margin-top: 20px;
      padding: 12px 24px;
      background: white;
      color: black;
      font-size: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingScreen">
    <div>Loading VR Experience...</div>
    <div id="enterBtn" style="display:none;">Click or Gaze Here to Enter</div>
  </div>

  <!-- A-Frame Scene -->
  <a-scene id="vrScene" embedded vr-mode-ui="enabled: true" loading-screen="enabled: false">
    <!-- Sky placeholder -->
    <a-sky id="sceneSky" color="#000000"></a-sky>

    <!-- Camera + Cursor -->
    <a-entity id="cameraRig">
      <a-camera position="0 1.6 0">
        <a-cursor
          id="cursor"
          fuse="true"
          fuse-timeout="1500"
          geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
          material="color: white; shader: flat"
        ></a-cursor>
      </a-camera>
    </a-entity>
  </a-scene>

<script>
(async function() {
  const loadingScreen = document.getElementById('loadingScreen');
  const enterBtn = document.getElementById('enterBtn');
  const vrScene = document.getElementById('vrScene');
  const sceneSky = document.getElementById('sceneSky');

  let currentAudio = null;

  // 1. Load global styles
  const styles = await fetch('config/styles.json').then(r => r.json());

  // 2. Fetch scene list dynamically
  const scenesManifest = await fetch('scenes/scenes.json').then(r=>r.json());

  // 3. Preload scene assets (sky images + scene audios)
  let assetsToLoad = [];
  scenesManifest.forEach(sceneNum => {
    assetsToLoad.push(`scenes/${sceneNum}/scene${sceneNum}.jpg`);
    assetsToLoad.push(`scenes/${sceneNum}/scene${sceneNum}.mp3`);
  });

  await Promise.all(assetsToLoad.map(src => {
    return new Promise(resolve => {
      if(src.endsWith('.jpg')){
        const img = new Image();
        img.src = src;
        img.onload = resolve;
      } else if(src.endsWith('.mp3')){
        const audio = new Audio();
        audio.src = src;
        audio.onloadeddata = resolve;
      } else resolve();
    });
  }));

  // Show enter button after loading
  enterBtn.style.display = 'block';

  const startScene = () => {
    loadingScreen.style.display = 'none';
    loadScene(scenesManifest[0]); // load first scene
  };

  enterBtn.addEventListener('click', startScene);
  enterBtn.addEventListener('mouseenter', () => startScene());

  // Utility to clear previous scene elements (except sky & camera)
  function clearScene(){
    Array.from(vrScene.children).forEach(el=>{
      if(el.id !== 'sceneSky' && el.id !== 'cameraRig'){
        vrScene.removeChild(el);
      }
    });
    if(currentAudio){ currentAudio.pause(); currentAudio=null; }
  }

  // Create a nav button entity
  function createNavButton(navData){
    const { text, gotoScene, position } = navData;
    const style = styles.navButton;

    // Button plane
    const button = document.createElement('a-plane');
    button.setAttribute('width', style.width || 2);
    button.setAttribute('height', style.height || 0.8);
    button.setAttribute('color', style.background || '#222222');
    button.setAttribute('position', position);
    button.setAttribute('look-at', '#cameraRig');
    button.setAttribute('class','navButton');

    // Text
    const btnText = document.createElement('a-text');
    btnText.setAttribute('value', text);
    btnText.setAttribute('color', style.color || '#fff');
    btnText.setAttribute('align','center');
    btnText.setAttribute('position','0 0 0.01');
    button.appendChild(btnText);

    // Interaction
    button.addEventListener('click', () => loadScene(gotoScene));

    return button;
  }

  // Load a scene dynamically
  async function loadScene(sceneNum){
    clearScene();

    // Set sky
    sceneSky.setAttribute('src', `scenes/${sceneNum}/scene${sceneNum}.jpg`);

    // Play scene audio
    currentAudio = new Audio(`scenes/${sceneNum}/scene${sceneNum}.mp3`);
    currentAudio.play();

    // Load scene metadata
    const sceneData = await fetch(`scenes/${sceneNum}/scene${sceneNum}.json`).then(r=>r.json());

    // Add multiple nav buttons
    if(sceneData.navButtons && sceneData.navButtons.length > 0){
      sceneData.navButtons.forEach(btnData => {
        const navBtn = createNavButton(btnData);
        vrScene.appendChild(navBtn);
      });
    }

    // TODO: dynamically load images, models, videos, buttons
  }

})();
</script>

</body>
</html>
